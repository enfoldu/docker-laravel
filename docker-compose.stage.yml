# docker-compose.stage.yml

version: '3.7'

volumes:
  db_data:
    driver: local
    name: "volume-${APP_ENV}-${APP_NAME}-${APP_VERSION}"

services:

  ## ================== DATABASE
  database:
    image: "database-${APP_ENV}-${APP_NAME}-${APP_VERSION}"
    build:
      context: .
      dockerfile: ./containers/${DB_DRIVER}/Dockerfile
      args:
        version: ${DB_VERSION}
        db_database: ${DB_DATABASE?Missing DB_DATABASE variable in .env}
        db_user: ${DB_USERNAME?Missing DB_USERNAME variable in .env}
        db_password: ${DB_PASSWORD?Missing DB_PASSWORD variable in .env}
        db_root_password: ${DB_PASSWORD?Missing DB_PASSWORD variable in .env}
    container_name: "database-${APP_ENV}-${APP_NAME}-${APP_VERSION}"
    volumes:
      - db_data:${DB_STORAGE_PATH}
    ports:
      - "${DB_EXTERNAL_PORT?Missing DB_PORT variable in .env}:3306"
    networks:
      - network
    expose:
      - ${DB_EXTERNAL_PORT?Missing DB_EXTERNAL_PORT variable in .env}

  ## ================== APP
  app:
    links:
      - database
